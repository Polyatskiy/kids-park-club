# Отчёт об отключении Vercel Image Optimization

**Дата:** 2025-01-27  
**Задача:** Полностью исключить Vercel Image Optimization для избежания расходов на трансформации изображений

---

## 1. Аудит и диагностика

### 1.1. Причина начислений

Vercel Image Optimization был активен из-за:
- Использования компонента `next/image` в 7 компонентах проекта
- Настроек оптимизации в `next.config.mjs` (formats, deviceSizes, imageSizes)
- Отсутствия флага `unoptimized: true`

**Найденные использования `next/image`:**
1. `components/similar-items.tsx` - миниатюры похожих элементов
2. `components/puzzle-browser.tsx` - карточки пазлов
3. `components/coloring-browser.tsx` - карточки раскрасок
4. `components/popular-item-card.tsx` - популярные элементы
5. `components/home-tile.tsx` - иконки на главной странице
6. `components/coloring-card.tsx` - карточки раскрасок (legacy)
7. `components/navbar.tsx` - логотип сайта

### 1.2. Источники изображений

- **Supabase Storage**: Основной источник изображений (раскраски и пазлы)
  - URL формат: `https://*.supabase.co/storage/v1/object/public/{bucket}/{path}`
  - Бакеты: `coloring`, `puzzles`
- **Локальные статические файлы**: Логотипы, иконки (`/assets/logo.png`, `/icons/*.png`)
- **Placeholder изображения**: `/placeholder.png`

### 1.3. Текущая конфигурация (ДО изменений)

```javascript
images: {
  remotePatterns: [
    {
      protocol: "https",
      hostname: "*.supabase.co",
      pathname: "/storage/v1/object/public/**",
    },
  ],
  formats: ['image/webp'],
  deviceSizes: [640, 828, 1200, 1920, 2048],
  imageSizes: [32, 64, 96, 128, 256],
  minimumCacheTTL: 2678400,
}
```

**Проблема:** При каждом запросе изображения Vercel выполнял трансформации:
- Ресайз под разные размеры экрана
- Конвертацию в WebP
- Оптимизацию качества
- Кеширование результатов

Это вызывало множественные трансформации для каждого изображения, особенно на страницах с сетками карточек.

---

## 2. Выбранное решение

### 2.1. Решение: Глобальное отключение через `unoptimized: true`

**Почему выбрано это решение:**

✅ **Минимальные изменения кода:** Требуется изменение только конфигурации  
✅ **Сохранение функциональности:** Компоненты `next/image` продолжают работать, но без оптимизации  
✅ **Совместимость:** Все существующие компоненты остаются валидными  
✅ **Простота поддержки:** Один флаг в конфигурации, легко контролировать  
✅ **Нулевые расходы:** Полностью исключает трансформации на стороне Vercel  

### 2.2. Альтернативы (не выбраны)

❌ **Замена на обычные `<img>` теги:**
- Требует изменения 7+ компонентов
- Потеря lazy loading и других оптимизаций браузера
- Больше кода для поддержки

❌ **Локальная оптимизация изображений:**
- Требует дополнительной инфраструктуры
- Сложность поддержки
- Нет гарантии отсутствия расходов

❌ **Внешний CDN для оптимизации:**
- Дополнительные расходы
- Сложность настройки
- Зависимость от внешнего сервиса

---

## 3. Внедрённые изменения

### 3.1. Изменения в конфигурации

**Файл:** `next.config.mjs`

```javascript
images: {
  // DISABLED: Completely disable Vercel Image Optimization to avoid transformation costs
  // All images will be served directly from their source URLs without any optimization
  unoptimized: true,
  remotePatterns: [
    {
      protocol: "https",
      hostname: "*.supabase.co",
      pathname: "/storage/v1/object/public/**",
    },
  ],
  // These settings are ignored when unoptimized: true, but kept for reference
  formats: ['image/webp'],
  deviceSizes: [640, 828, 1200, 1920, 2048],
  imageSizes: [32, 64, 96, 128, 256],
  minimumCacheTTL: 2678400,
}
```

### 3.2. Компоненты (не требуют изменений)

Все компоненты, использующие `next/image`, автоматически работают с `unoptimized: true`:
- `components/similar-items.tsx` ✅
- `components/puzzle-browser.tsx` ✅
- `components/coloring-browser.tsx` ✅
- `components/popular-item-card.tsx` ✅
- `components/home-tile.tsx` ✅
- `components/coloring-card.tsx` ✅
- `components/navbar.tsx` ✅

### 3.3. Как это работает

При `unoptimized: true`:
- Компонент `next/image` отображает изображения напрямую из источника
- Нет запросов к `/_next/image?url=...`
- Нет трансформаций на стороне Vercel
- Изображения загружаются напрямую с Supabase Storage или из статических файлов
- Сохраняются все преимущества компонента (lazy loading, responsive, alt text)

---

## 4. Тестирование и проверка

### 4.1. Локальная проверка

✅ **Сборка проекта:** `npm run build` - успешно  
✅ **Проверка TypeScript:** Все типы корректны  
✅ **Статическая генерация:** Все страницы сгенерированы  

### 4.2. Как проверить после деплоя

#### 4.2.1. Проверка отсутствия трансформаций

**В DevTools (Network tab):**
- ❌ НЕ должно быть запросов к `/_next/image?url=...`
- ✅ Должны быть прямые запросы к Supabase Storage URLs
- ✅ Локальные изображения загружаются напрямую

**Пример правильных URL:**
```
✅ https://*.supabase.co/storage/v1/object/public/coloring/...
✅ https://*.supabase.co/storage/v1/object/public/puzzles/...
✅ /assets/logo.png
```

**Пример неправильных URL (не должно быть):**
```
❌ /_next/image?url=https%3A%2F%2F*.supabase.co%2F...
❌ /_next/image?url=%2Fassets%2Flogo.png
```

#### 4.2.2. Проверка в Vercel Dashboard

**Observability → Image Optimization:**
- Трансформации должны быть равны 0 после деплоя
- Новые запросы не должны появляться

#### 4.2.3. Проверка ключевых страниц

**Тестовые сценарии:**
1. ✅ Главная страница (`/`) - логотип и иконки загружаются
2. ✅ Страница раскрасок (`/coloring`) - сетка карточек отображается
3. ✅ Страница пазлов (`/games/jigsaw/gallery`) - сетка карточек отображается
4. ✅ Одна раскраска (`/coloring/[slug]`) - изображение загружается
5. ✅ Один пазл (`/games/jigsaw?imageId=...`) - изображение загружается
6. ✅ Похожие элементы - миниатюры загружаются

#### 4.2.4. Проверка производительности

**Метрики не должны ухудшиться:**
- LCP (Largest Contentful Paint) - должен остаться в норме
- CLS (Cumulative Layout Shift) - не должно быть ухудшений
- Загрузка изображений - должна быть стабильной

**Важно:** Изображения могут быть немного больше по размеру (без WebP оптимизации), но это компенсируется отсутствием задержек на трансформацию.

---

## 5. Инструкции по деплою

### 5.1. Предварительные шаги

1. Убедитесь, что изменения закоммичены:
   ```bash
   git add next.config.mjs
   git commit -m "Disable Vercel Image Optimization to avoid transformation costs"
   ```

2. Проверьте локальную сборку:
   ```bash
   npm run build
   ```

### 5.2. Деплой

1. Запушьте изменения в репозиторий:
   ```bash
   git push origin main
   ```

2. Дождитесь автоматического деплоя на Vercel (если включен автодеплой)

   ИЛИ

   Запустите деплой вручную:
   ```bash
   vercel --prod
   ```

### 5.3. Пост-деплой проверка

1. Откройте сайт в браузере
2. Откройте DevTools → Network tab
3. Обновите страницу несколько раз
4. Проверьте, что НЕТ запросов к `/_next/image`
5. Проверьте Vercel Dashboard → Observability → Image Optimization
6. Убедитесь, что новые трансформации не появляются

---

## 6. Рекомендации по дальнейшей поддержке

### 6.1. Мониторинг

**Регулярно проверяйте:**
- Vercel Dashboard → Observability → Image Optimization (должно быть 0)
- Размер bundle (не должен увеличиться)
- Производительность сайта (Core Web Vitals)

### 6.2. Если нужна оптимизация изображений в будущем

**Вариант 1: Предварительная оптимизация при загрузке**
- Оптимизируйте изображения локально перед загрузкой в Supabase
- Используйте инструменты типа `sharp`, `imagemin`
- Сохраняйте оптимизированные версии в Storage

**Вариант 2: Использование CDN с оптимизацией**
- Настройте Cloudflare Images или другой CDN
- Используйте их URL вместо прямых Supabase URLs
- Получите оптимизацию без расходов Vercel

**Вариант 3: Локальная оптимизация в CI/CD**
- Добавьте шаг оптимизации в GitHub Actions / CI
- Генерируйте оптимизированные версии при загрузке
- Сохраняйте в Storage готовые оптимизированные изображения

### 6.3. Важные замечания

⚠️ **НЕ удаляйте `remotePatterns`:**
- Они всё ещё нужны для безопасности (валидация источников)
- Next.js проверяет, что изображения из разрешённых доменов

⚠️ **НЕ добавляйте `unoptimized` prop в компоненты:**
- Глобальный флаг в конфигурации достаточно
- Локальные props могут конфликтовать

⚠️ **Размер изображений:**
- Изображения теперь загружаются в оригинальном размере
- Следите за размером файлов в Supabase Storage
- При необходимости оптимизируйте изображения перед загрузкой

### 6.4. Обратная совместимость

✅ Все существующие компоненты работают без изменений  
✅ API не изменился  
✅ Поведение компонентов идентично (кроме оптимизации)  

---

## 7. Итоговая сводка

### 7.1. Что было сделано

- ✅ Отключена Vercel Image Optimization через `unoptimized: true` в `next.config.mjs`
- ✅ Все компоненты продолжают работать без изменений
- ✅ Проверена локальная сборка - успешно
- ✅ Документированы все изменения

### 7.2. Результат

- ✅ **Нулевые расходы на Image Optimization:** Трансформации полностью отключены
- ✅ **Сохранена функциональность:** Все компоненты работают как прежде
- ✅ **Минимальные изменения:** Изменён только один файл конфигурации
- ✅ **Простота поддержки:** Легко включить/выключить через один флаг

### 7.3. Файлы изменений

```
Modified:
  - next.config.mjs (добавлен unoptimized: true)

Unchanged (работают автоматически):
  - components/similar-items.tsx
  - components/puzzle-browser.tsx
  - components/coloring-browser.tsx
  - components/popular-item-card.tsx
  - components/home-tile.tsx
  - components/coloring-card.tsx
  - components/navbar.tsx
```

---

## 8. Контакты и вопросы

Если возникнут проблемы:
1. Проверьте Network tab в DevTools на наличие `/_next/image` запросов
2. Убедитесь, что `unoptimized: true` установлен в `next.config.mjs`
3. Проверьте логи Vercel Dashboard на ошибки
4. Убедитесь, что изображения доступны по прямым URL (Supabase Storage)

---

**Статус:** ✅ Готово к деплою  
**Риски:** Низкие (минимальные изменения, обратная совместимость сохранена)  
**Рекомендация:** Деплой в production можно выполнить сразу после проверки

